#!/usr/bin/env bash
set -euo pipefail

input=$(cat)
tool=$(echo "$input" | jq -r '.preToolUse.toolName // .tool // empty')
params=$(echo "$input" | jq -c '.preToolUse.parameters // .args // {}')

if [[ -z "$tool" ]]; then
  echo '{"cancel": false}'
  exit 0
fi

# ---------- Read guard (token + hallucination control) ----------
if [[ "$tool" == "read_file" ]]; then
  path=$(echo "$params" | jq -r '.path // empty')

  if [[ -n "$path" ]]; then
    # Skip highly noisy or generated files.
    if [[ "$path" =~ (^|/)(package-lock\.json|yarn\.lock|pnpm-lock\.yaml)$ ]]; then
      echo '{"cancel": true, "errorMessage": "Blocked lockfile read. Use targeted source files instead."}'
      exit 0
    fi

    if [[ "$path" =~ (^|/)(node_modules|\.next|dist|build|coverage)(/|$) ]]; then
      echo '{"cancel": true, "errorMessage": "Blocked generated/dependency path. Read source files instead."}'
      exit 0
    fi

    if [[ "$path" == *.log ]]; then
      echo '{"cancel": true, "errorMessage": "Use terminal tail/head for logs instead of full file reads."}'
      exit 0
    fi

    # Session-local redundant read tracking.
    history_dir=".clinerules/.cache"
    history_file="$history_dir/read_history.log"
    mkdir -p "$history_dir"

    if [[ -f "$history_file" ]] && grep -Fxq "$path" "$history_file"; then
      echo "{\"cancel\": true, \"errorMessage\": \"Redundant read blocked: $path already read this session.\"}"
      exit 0
    fi

    echo "$path" >> "$history_file"

    # Encourage surgical reads for large files.
    if [[ -f "$path" ]]; then
      line_count=$(wc -l < "$path" | tr -d ' ')
      if [[ "$line_count" -gt 300 ]]; then
        echo '{"cancel": true, "errorMessage": "Large file read blocked (>300 lines). Use search + smart_read.py ranges."}'
        exit 0
      fi
    fi
  fi
fi

# ---------- Write guard (safety + performance) ----------
if [[ "$tool" == "write_file" || "$tool" == "write_to_file" || "$tool" == "edit_block" ]]; then
  path=$(echo "$params" | jq -r '.path // .target_file // empty')

  if [[ -n "$path" ]]; then
    if [[ "$path" =~ (^|/)(package-lock\.json|yarn\.lock|pnpm-lock\.yaml)$ ]]; then
      echo '{"cancel": true, "errorMessage": "Blocked lockfile write. Modify source files and regenerate lockfiles via package manager."}'
      exit 0
    fi

    if [[ "$path" =~ (^|/)(node_modules|\.next|dist|build|coverage)(/|$) ]]; then
      echo '{"cancel": true, "errorMessage": "Blocked write to generated/dependency path."}'
      exit 0
    fi
  fi
fi

echo '{"cancel": false}'
